<!doctype html>
<meta charset=utf-8>
<body id=b>
<script>
d = document;

/*
Useful constants:
35633 = g.VERTEX_SHADER
35632 = g.FRAGMENT_SHADER
35044 = g.STATIC_DRAW
34962 = g.ARRAY_BUFFER
5120 = g.BYTE
6 = g.TRIANGLE_FAN
*/

/* Golf starts here */

// GUI
b.innerHTML+=`<canvas id=a width=600 height=400 style='border:1px solid#000;width:50vw;height:95vh'>`;
b.innerHTML+=`<textarea id=c style='width:46vw;height:95vh' spellcheck=false>void mainImage(out vec4 fragColor,in vec2 fragCoord){
  vec4 p=vec4((fragCoord.xy/iResolution.xy-.5)*2.,0,1);
  fragColor=p+sin(atan(p.y,p.x)*9.)*sin(p*iGlobalTime/2.+9./dot(p,p)+iGlobalTime*5.);
}`;


// WebGL context
g = a.getContext("webgl");

// Read hash
if(l=location.hash){
  c.value=atob(l.slice(1));
}

// Mouse coordinates
iMouse=[];

// Onload / oninput
(oninput=function(){

  // Update hash
  //location.hash=btoa(c.value);

  // Define a new program
  P=g.createProgram();

  // Basic vertex shader
  g.shaderSource(S=g.createShader(g.VERTEX_SHADER),"attribute vec2 P;void main(){gl_Position=vec4(P,0,1);}");

  // Compile and attach it to the program
  g.compileShader(S);
  g.attachShader(P,S);

  // Main program
  g.shaderSource(S=g.createShader(g.FRAGMENT_SHADER),`precision mediump float;uniform float iGlobalTime,iFrame,iDate;varying lowp vec4 fragCoord;uniform vec2 iResolution;uniform vec4 iMouse;` + c.value + `void main(){mainImage(gl_FragColor,gl_FragCoord.xy);gl_FragColor.w=1.;}`);

  // Compile and attach it to the program
  g.compileShader(S);
  g.attachShader(P,S);

  // Link and start the program
  g.linkProgram(P);
  g.useProgram(P);

  // Define a big triangle the canvas, containing the viewport
  g.bindBuffer(B=g.ARRAY_BUFFER,g.createBuffer());
  g.enableVertexAttribArray(0);
  g.vertexAttribPointer(0,2,g.BYTE,0,0,0);
  g.bufferData(B,new Int8Array([-3,1,1,-3,1,1]),g.STATIC_DRAW);

  // Main loop
  iGlobalTime=0;
  iFrame=0;
})();

// Time
d=new Date();

// Main loop
(L=function(){
  // Current playback time
  g.uniform1f(g.getUniformLocation(P,"iGlobalTime"),iGlobalTime+=.016);
  
  // Current playback frame
  g.uniform1f(g.getUniformLocation(P,"iFrame"),iFrame++);
  
  // Time delta
  g.uniform1f(g.getUniformLocation(P,"iTimeDelta"), d-(d=new Date()));
  
  // Time delta
  g.uniform1f(g.getUniformLocation(P,"iDate"), ~~(d/1000));
  
  // Mouse coordinates
  g.uniform4f(g.getUniformLocation(P,"iMouse"),iMouse[0],iMouse[1],iMouse[2],iMouse[3]);
  
  // Viewport resolution
  g.uniform2f(g.getUniformLocation(P,"iResolution"),640,360);
  
  // Draw
  g.drawArrays(g.TRIANGLE_FAN,0,3);
  
  // Next frame
  requestAnimationFrame(L);
})();

// Mouse coordinates
a.onmousemove=e=>{iMouse[0]=e.pageX;iMouse[1]=e.pageY}
a.onclick=e=>{iMouse[2]=e.pageX;iMouse[3]=e.pageY}

/* End of golf */

</script>