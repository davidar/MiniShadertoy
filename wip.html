<!doctype html>
<meta charset=utf-8>
<body id=b>
<script>
d = document;

/*
=========================
 WebGL Shader Playground
=========================

by The Codegolf Team
Inspired by www.shadertoy.com
Based on http://xem.github.com/MiniShadertoy
Full story on http://xem.github.io/articles/#webgl_quest

~~~

This demo provides a fully functional WebGL shader playground,
with a built-in demo, mouse support, shareable URLs, and a 2-way compatibility with Shadertoy.

Demos created in this playground also work on Shadertoy,
and Shadertoy's demos that only feature a shader (i.e. no channels or other assets) will also work here.
(for example: https://www.shadertoy.com/view/Ms2SD1)

The canvas can also be set to full size by double-clicking it.

~~~

The shader inputs are the same as the ones provided by Shadertoy:

uniform vec3  iResolution; // viewport resolution = vec2(640.0, 360.0)
uniform float iGlobalTime; // playback time (in seconds)
uniform float iTimeDelta;  // render time since last frame (in seconds)
uniform int   iFrame;      // playback frame
uniform vec4  iMouse;      // mouse pixel coords. xy: current (if left button down), zw: click
uniform vec4  iDate;       // current timestamp in seconds

Your code is executed from the following function:

void mainImage(out vec4 fragColor,in vec2 fragCoord){
  // code
}

~~~

Commented source:


/*
Useful constants:
35633 = g.VERTEX_SHADER
35632 = g.FRAGMENT_SHADER
35044 = g.STATIC_DRAW
34962 = g.ARRAY_BUFFER
5120 = g.BYTE
6 = g.TRIANGLE_FAN
*/

/* Golf starts here */

// GUI:
// Canvas
b.innerHTML+=`<canvas id=a width=600 height=400 style='border:1px solid#000;width:47vw;height:95vh'>`;

// Textarea with demo shader
b.innerHTML+=`<textarea id=c style='width:47vw;height:95vh' spellcheck=false>void mainImage(out vec4 fragColor,in vec2 fragCoord){
  vec4 p=vec4((fragCoord.xy/iResolution.xy-.5)*2.,0,1);
  fragColor=p+sin(atan(p.y,p.x)*9.)*sin(p*iGlobalTime/2.+9./dot(p,p)+iGlobalTime*5.);
}`;


// WebGL context
g = a.getContext("webgl");

// Read hash
if(l=location.hash){
  c.value=atob(l.slice(1));
}

// Mouse coordinates
iMouse=[0,0,0,0];

// Onload / oninput
(oninput=function(){

  // Update hash
  //location.hash=btoa(c.value);

  // Define a new program
  P=g.createProgram();

  // Basic vertex shader
  g.shaderSource(S=g.createShader(g.VERTEX_SHADER),"attribute vec2 P;void main(){gl_Position=vec4(P,0,1);}");

  // Compile and attach it to the program
  g.compileShader(S);
  g.attachShader(P,S);

  // Main program
  g.shaderSource(S=g.createShader(g.FRAGMENT_SHADER),`precision mediump float;uniform float iGlobalTime,iFrame,iDate,iTimeDelta;varying lowp vec4 fragCoord;uniform vec2 iResolution;uniform vec4 iMouse;` + c.value + `void main(){mainImage(gl_FragColor,gl_FragCoord.xy);gl_FragColor.w=1.;}`);

  // Compile and attach it to the program
  g.compileShader(S);
  g.attachShader(P,S);

  // Link and start the program
  g.linkProgram(P);
  g.useProgram(P);

  // Define a big triangle the canvas, containing the viewport
  g.bindBuffer(B=g.ARRAY_BUFFER,g.createBuffer());
  g.enableVertexAttribArray(0);
  g.vertexAttribPointer(0,2,g.BYTE,0,0,0);
  g.bufferData(B,new Int8Array([-3,1,1,-3,1,1]),g.STATIC_DRAW);

  // Frame
  iFrame=0;

  // Playback time (in seconds)
  p = 0;
  
  // Date (in seconds)
  D = new Date() / 1000
  
  // Time delta (in seconds)
  d = 0;
})();



// Main loop
(L=function(){

  // Time delta since last frame (in seconds)
  d = (new Date() / 1000 - D);

  // Date (in seconds)
  D = new Date() / 1000;
  
  g.uniform1f(g.getUniformLocation(P,"iTimeDelta"), d);

  // Current playback time (in seconds)
  g.uniform1f(g.getUniformLocation(P,"iGlobalTime"), p += d);
  
  // Current playback frame
  g.uniform1f(g.getUniformLocation(P,"iFrame"),iFrame++);  
  
  // Date
  g.uniform1f(g.getUniformLocation(P,"iDate"), ~~D);
  
  // Mouse coordinates
  g.uniform4f(g.getUniformLocation(P,"iMouse"),iMouse[0],iMouse[1],iMouse[2],iMouse[3]);
  
  // Viewport resolution
  g.uniform2f(g.getUniformLocation(P,"iResolution"),640, 360);
  
  // Draw
  g.drawArrays(g.TRIANGLE_FAN,0,3);
  
  // Next frame
  requestAnimationFrame(L);
})();

// Mouse input
y=0;
z=1;
onmousedown=onmouseup=function(e){y^=1}
a.onmousemove=function(e){if(y)iMouse[0]=e.pageX*0.47*z,iMouse[1]=e.pageY}
a.onclick=function(e){iMouse[2]=e.pageX*0.47*z,iMouse[3]=e.pageY}
a.ondblclick=function(e){z=3-z;a.style.width=c.style.width=z*47+'vw'}

/* End of golf */

</script>