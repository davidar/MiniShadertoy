<canvas id=c>
<script>
c.width=c.height=1024;
g=c.getContext`webgl2`;

//g.getExtension("EXT_color_buffer_float");
g.getExtension(g.getSupportedExtensions()[0]);

P=g.createProgram();

// compile shader
C=(t,s)=>{
  g.shaderSource(S=g.createShader(t),"#version 300 es\n"+s);
  g.compileShader(S);
  //if (!g.getShaderParameter(S, g.COMPILE_STATUS)) {
  //  g.getShaderInfoLog(S).trim().split("\n").forEach(ss => console.warn("[shader] " + ss))
  //  throw new Error("Error while compiling shader")
  //};
  g.attachShader(P,S);
}

C(g.VERTEX_SHADER,`
void main(){
  gl_Position.w=gl_PointSize=1e4;
}
`);

C(g.FRAGMENT_SHADER,`
out highp vec4 O;
uniform int F;
uniform sampler2D B;
#define A texelFetch(B,ivec2(i+u),0)
void main(){
  highp vec2 u=gl_FragCoord.xy,v,i=u-u;O-=O;
  for(int k=0;k++<169;v=A.xy/.1+i,O+=vec4(v-i+v-v*A.w,0,1)*A.w/exp(dot(v,v))/3.142)
    i=vec2(k%13,k/13)-6.;
  O.xy/=O.w/.1+1e-6;
  F%500<2?O+=vec4(u/1e4-.05,0,.3):O;
}
`);

g.linkProgram(P);
g.useProgram(P);

F=0;
X=[];
B=[];
for(i of [0,1]) {
  g.bindTexture(g.TEXTURE_2D, X[i]=g.createTexture());
  g.texImage2D(g.TEXTURE_2D, 0, g.RGBA16F, 1024, 1024, 0, g.RGBA, g.FLOAT, null);
  g.bindFramebuffer(g.FRAMEBUFFER, B[i]=g.createFramebuffer());
  g.framebufferTexture2D(g.FRAMEBUFFER, g.COLOR_ATTACHMENT0, g.TEXTURE_2D, X[i], 0);
}

R=b=>{
  g.bindFramebuffer(g.FRAMEBUFFER, b);
  g.bindTexture(g.TEXTURE_2D, X[F%2]);
  g.generateMipmap(g.TEXTURE_2D);
  g.uniform1i(g.getUniformLocation(P,"F"),F);
  g.drawArrays(g.POINTS,0,1);
}

(L=()=>{
  // render to buffer
  R(B[F++%2]);
  // render again to screen
  R(); 
  requestAnimationFrame(L);
})();
</script>
